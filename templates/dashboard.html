<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../static/css/dashboard.css" />
    <link rel="stylesheet" href="chart-styles.css" />
    <title>Temp Dashboard</title>
    <style>
      /* Add your custom CSS here */

      /* Add your custom CSS here */
      body.dark {
        background-color: #121212;
        color: #e0e0e0;
      }

      body.dark .sidebar,
      body.dark .content nav,
      body.dark .content main {
        background-color: #333;
        color: #e0e0e0;
      }

      body.dark .sidebar .side-menu li a {
        color: #e0e0e0;
      }

      body.dark .sidebar .side-menu li.active a {
        background-color: #444;
      }

      body.dark .sidebar .side-menu li a:hover {
        background-color: #444;
      }

      body.dark .content-section h2 {
        color: #e0e0e0;
      }

      .device-counter {
        display: flex;
        align-items: center;
        margin-top: 20px;
      }

      .device-counter button {
        width: 30px;
        height: 30px;
        font-size: 20px;
        text-align: center;
        line-height: 30px;
        border: 1px solid #ddd;
        background-color: #f2f2f2;
        cursor: pointer;
      }

      .device-counter span {
        width: 30px;
        text-align: center;
        margin: 0 10px;
        font-size: 20px;
      }

      #device-list {
        margin-top: 20px;
      }

      .content-section {
        display: none;
      }

      .table-container {
        margin-top: 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }

      th {
        background-color: #f2f2f2;
      }

      .device-item {
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 10px;
        background-color: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .device-item p {
        margin: 5px 0;
      }

      .notif-content {
        display: none;
        background-color: #fff;
        border: 1px solid #ddd;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 10px;
        max-width: 300px;
        position: absolute;
        right: 20px;
        top: 50px;
        z-index: 1000;
        border-radius: 8px;
      }

      .notif-content ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .notif-content ul li {
        border-bottom: 1px solid #ddd;
        padding: 10px;
        transition: background-color 0.3s;
      }

      .notif-content ul li:hover {
        background-color: #f9f9f9;
      }

      .notif-content ul li:last-child {
        border-bottom: none;
      }

      .notif {
        position: relative;
        cursor: pointer;
      }

      .notif .count {
        background-color: red;
        color: white;
        font-size: 12px;
        border-radius: 50%;
        padding: 2px 6px;
        position: absolute;
        top: -5px;
        right: -5px;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <a href="#" class="logo">
        <i class="bx bx-code-alt"></i>
        <div class="logo-name"><span>TIB</span></div>
      </a>
      <ul class="side-menu">
        <li>
          <a href="#" id="dashboard-link"
            ><i class="bx bxs-dashboard"></i>Dashboard</a
          >
        </li>
        <li class="active">
          <a href="#" id="analytics-link"
            ><i class="bx bx-analyse"></i>Analytics</a
          >
        </li>
        <li>
          <a href="#" id="request-device-link"
            ><i class="bx bx-devices"></i>Request Device Data</a
          >
        </li>
        <li>
          <a href="#" id="add-device-link"
            ><i class="bx bx-devices"></i>Add Device
          </a>
        </li>
        <li>
          <a href="#" id="get-device-link"
            ><i class="bx bx-devices"></i>Get Device Data</a
          >
        </li>
      </ul>
      <ul class="side-menu">
        <li>
          <a href="#" id="logout-link" class="logout"
            ><i class="bx bx-log-out-circle"></i>Logout</a
          >
        </li>
      </ul>
    </div>
    <div class="content">
      <nav>
        <i class="bx bx-menu"></i>
        <form action="#">
          <div class="form-input">
            <input type="search" placeholder="Search..." />
            <button class="search-btn" type="submit">
              <i class="bx bx-search"></i>
            </button>
          </div>
        </form>
        <input type="checkbox" id="theme-toggle" hidden />
        <label for="theme-toggle" class="theme-toggle"></label>
        <a href="#" class="notif">
          <i class="bx bx-bell"></i><span class="count">1</span>
          <div class="notif-content">
            <ul id="notification-list"></ul>
          </div>
        </a>
        <a href="#" id="loadProfile">
          <img
            src="https://img.icons8.com/?size=100&id=rrtYnzKMTlUr&format=png&color=000000"
            alt="Profile"
            class="profile-img"
          />
        </a>
      </nav>
      <main>
        <div class="header" id="clickable-div">
          <div class="left">
            <h1>Dashboard</h1>
            <ul class="breadcrumb"></ul>
          </div>
        </div>
        <div id="dashboard-content" class="content-section">
          <h2>Dashboard Content</h2>
          <p>
            Welcome to the dashboard! Here you can see an overview of your
            activity.
          </p>
        </div>
        <div id="analytics-content" class="content-section">
          <h2>Analytics Content</h2>
          <div class="chart-container">
            <h1 class="chart-title">Voltage</h1>
            <canvas id="voltageChart"></canvas>
            <div id="voltageTable" class="table-container"></div>
          </div>
          <div class="chart-container">
            <h1 class="chart-title">Current</h1>
            <canvas id="currentChart"></canvas>
            <div id="currentTable" class="table-container"></div>
          </div>
          <div class="chart-container">
            <h1 class="chart-title">Power</h1>
            <canvas id="powerChart"></canvas>
            <div id="powerTable" class="table-container"></div>
          </div>
          <div class="chart-container">
            <h1 class="chart-title">Brightness Level</h1>
            <canvas id="brightnessChart"></canvas>
            <div id="brightnessTable" class="table-container"></div>
          </div>
          <div class="chart-container">
            <h1 class="chart-title">Battery Temperature</h1>
            <canvas id="batteryChart"></canvas>
            <div id="batteryTable" class="table-container"></div>
          </div>
        </div>
        <div id="device-content" class="content-section">
          <h2>Request Device Data</h2>
          <form method="POST" action="/dashboard/request_device">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="device-counter">
              <button
                id="decrease-device"
                type="button"
                onclick="changeDeviceCount(-1)"
              >
                -
              </button>
              <span id="device-count">0</span>
              <button
                id="increase-device"
                type="button"
                onclick="changeDeviceCount(1)"
              >
                +
              </button>
            </div>
            <input
              type="hidden"
              id="device_count"
              name="device_count"
              value="0"
            />
            <button id="request-device" type="submit">Request</button>
          </form>
          <div id="device-list"></div>
        </div>

        <div id="add-device" class="content-section">
          <h2>Add Devices</h2>
          <form id="device-form" method="POST" action="/dashboard/add_device">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

            <label for="entityName">Entity Name</label>
            <input type="text" id="entityName" name="entityName" required />
            <label for="deviceIMEI">Device IMEI</label>
            <input type="text" id="deviceIMEI" name="deviceIMEI" required />
            <label for="simICCId">SIM ICC ID</label>
            <input type="text" id="simICCId" name="simICCId" required />
            <label for="batterySLNo">Battery SL No</label>
            <input type="text" id="batterySLNo" name="batterySLNo" required />
            <label for="panelSLNo">Panel SL No</label>
            <input type="text" id="panelSLNo" name="panelSLNo" required />
            <label for="luminarySLNo">Luminary SL No</label>
            <input type="text" id="luminarySLNo" name="luminarySLNo" required />
            <label for="mobileNo">Mobile No</label>
            <input type="text" id="mobileNo" name="mobileNo" required />
            <label for="district">District</label>
            <input type="text" id="district" name="district" required />
            <label for="panchayat">Panchayat</label>
            <input type="text" id="panchayat" name="panchayat" required />
            <label for="block">Block</label>
            <input type="text" id="block" name="block" required />
            <label for="wardNo">Ward No</label>
            <input type="text" id="wardNo" name="wardNo" required />
            <label for="poleNo">Pole No</label>
            <input type="text" id="poleNo" name="poleNo" required />
            <label for="active">Active</label>
            <select id="active" name="active" required>
              <option value="true">True</option>
              <option value="false">False</option>
            </select>
            <label for="installationDate">Installation Date</label>
            <input
              type="date"
              id="installationDate"
              name="installationDate"
              required
            />
            <button type="submit">Submit</button>
          </form>
        </div>
        <div id="view-device-content" class="content-section">
          <h2>View Devices Content</h2>

          <div id="device-list1">
            <!-- Device data will be injected here -->
          </div>
        </div>
      </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@latest"></script>
    <script>
      const toggler = document.getElementById("theme-toggle");

      toggler.addEventListener("change", function () {
        if (this.checked) {
          document.body.classList.add("dark");
        } else {
          document.body.classList.remove("dark");
        }
      });
      const sideLinks = document.querySelectorAll(
        ".sidebar .side-menu li a:not(.logout)"
      );

      sideLinks.forEach((item) => {
        const li = item.parentElement;
        item.addEventListener("click", () => {
          sideLinks.forEach((i) => {
            i.parentElement.classList.remove("active");
          });
          li.classList.add("active");
        });
      });

      const menuBar = document.querySelector(".content nav .bx.bx-menu");
      const sideBar = document.querySelector(".sidebar");

      menuBar.addEventListener("click", () => {
        sideBar.classList.toggle("close");
      });

      const searchBtn = document.querySelector(
        ".content nav form .form-input button"
      );
      const searchBtnIcon = document.querySelector(
        ".content nav form .form-input button .bx"
      );
      const searchForm = document.querySelector(".content nav form");

      searchBtn.addEventListener("click", function (e) {
        if (window.innerWidth < 576) {
          e.preventDefault;
          searchForm.classList.toggle("show");
          if (searchForm.classList.contains("show")) {
            searchBtnIcon.classList.replace("bx-search", "bx-x");
          } else {
            searchBtnIcon.classList.replace("bx-x", "bx-search");
          }
        }
      });

      window.addEventListener("resize", () => {
        if (window.innerWidth < 768) {
          sideBar.classList.add("close");
        } else {
          sideBar.classList.remove("close");
        }
        if (window.innerWidth > 576) {
          searchBtnIcon.classList.replace("bx-x", "bx-search");
          searchForm.classList.remove("show");
        }
      });
      document.addEventListener("DOMContentLoaded", function () {
        const data = [
          {
            BC: "3.8",
            BCPr: "5",
            BDPr: "10",
            BF: "15",
            BP: "20",
            BTem: "25",
            BV: "30",
            BrL: "35",
            D_ID: "863070045917753",
            GIS: "28.670730_77.094190",
            GPSP: "240",
            HEn: "40",
            LC: "45",
            LF: "50",
            LP: "55",
            LSt: "60",
            LV: "65",
            MF: "70",
            PC: "75",
            PP: "80",
            PV: "85",
            SSL_ID: "56401204",
            SSt: "1",
            S_ID: "8991102405968636027",
            date: "2023-07-01",
          },
          {
            BC: "3.9",
            BCPr: "6",
            BDPr: "12",
            BF: "18",
            BP: "24",
            BTem: "30",
            BV: "36",
            BrL: "42",
            D_ID: "863070045917753",
            GIS: "28.670730_77.094190",
            GPSP: "240",
            HEn: "48",
            LC: "54",
            LF: "60",
            LP: "66",
            LSt: "72",
            LV: "78",
            MF: "84",
            PC: "90",
            PP: "96",
            PV: "102",
            SSL_ID: "56401204",
            SSt: "1",
            S_ID: "8991102405968636027",
            date: "2023-07-02",
          },
          {
            BC: "4.0",
            BCPr: "7",
            BDPr: "14",
            BF: "21",
            BP: "28",
            BTem: "35",
            BV: "42",
            BrL: "49",
            D_ID: "863070045917753",
            GIS: "28.670730_77.094190",
            GPSP: "240",
            HEn: "56",
            LC: "63",
            LF: "70",
            LP: "77",
            LSt: "84",
            LV: "91",
            MF: "98",
            PC: "105",
            PP: "112",
            PV: "119",
            SSL_ID: "56401204",
            SSt: "1",
            S_ID: "8991102405968636027",
            date: "2023-07-03",
          },
          {
            BC: "4.1",
            BCPr: "8",
            BDPr: "16",
            BF: "24",
            BP: "32",
            BTem: "40",
            BV: "48",
            BrL: "56",
            D_ID: "863070045917753",
            GIS: "28.670730_77.094190",
            GPSP: "240",
            HEn: "64",
            LC: "72",
            LF: "80",
            LP: "88",
            LSt: "96",
            LV: "104",
            MF: "112",
            PC: "120",
            PP: "128",
            PV: "136",
            SSL_ID: "56401204",
            SSt: "1",
            S_ID: "8991102405968636027",
            date: "2023-07-04",
          },
          {
            BC: "3.9",
            BCPr: "6",
            BDPr: "12",
            BF: "18",
            BP: "24",
            BTem: "30",
            BV: "36",
            BrL: "42",
            D_ID: "863070045917753",
            GIS: "28.670730_77.094190",
            GPSP: "240",
            HEn: "48",
            LC: "54",
            LF: "60",
            LP: "66",
            LSt: "72",
            LV: "78",
            MF: "84",
            PC: "90",
            PP: "96",
            PV: "102",
            SSL_ID: "56401204",
            SSt: "1",
            S_ID: "8991102405968636027",
            date: "2023-07-05",
          },
          {
            BC: "3.7",
            BCPr: "4",
            BDPr: "8",
            BF: "12",
            BP: "16",
            BTem: "20",
            BV: "24",
            BrL: "28",
            D_ID: "863070045917753",
            GIS: "28.670730_77.094190",
            GPSP: "240",
            HEn: "32",
            LC: "36",
            LF: "40",
            LP: "44",
            LSt: "48",
            LV: "52",
            MF: "56",
            PC: "60",
            PP: "64",
            PV: "68",
            SSL_ID: "56401204",
            SSt: "1",
            S_ID: "8991102405968636027",
            date: "2023-07-06",
          },
          {
            error: "300",
            date: "2023-07-07",
          },
        ];

        processChartData(data);

        function processChartData(data) {
          const labels = [];
          const voltageData = [];
          const currentData = [];
          const powerData = [];
          const brightnessData = [];
          const batteryData = [];

          data.forEach((record) => {
            labels.push(record.date);
            voltageData.push(record.PV);
            currentData.push(record.PC);
            powerData.push(record.PP);
            brightnessData.push(record.BrL);
            batteryData.push(record.BTem);
          });

          createChart(
            "voltageChart",
            "Voltage",
            labels,
            voltageData,
            "Voltage (V)",
            "voltageTable"
          );
          createChart(
            "currentChart",
            "Current",
            labels,
            currentData,
            "Current (A)",
            "currentTable"
          );
          createChart(
            "powerChart",
            "Power",
            labels,
            powerData,
            "Power (W)",
            "powerTable"
          );
          createChart(
            "brightnessChart",
            "Brightness Level",
            labels,
            brightnessData,
            "Brightness (%)",
            "brightnessTable"
          );
          createChart(
            "batteryChart",
            "Battery Temperature",
            labels,
            batteryData,
            "Temperature (°C)",
            "batteryTable"
          );
        }

        function createChart(
          chartId,
          title,
          labels,
          data,
          yAxisLabel,
          tableId
        ) {
          const ctx = document.getElementById(chartId).getContext("2d");

          new Chart(ctx, {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: title,
                  data: data,
                  borderColor: "rgba(75, 192, 192, 1)",
                  backgroundColor: "rgba(75, 192, 192, 0.2)",
                  fill: true,
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                x: {
                  type: "time",
                  time: {
                    unit: "day",
                    tooltipFormat: "MMM dd yyyy",
                  },
                },
                y: {
                  title: {
                    display: true,
                    text: yAxisLabel,
                  },
                },
              },
            },
          });

          generateTable(tableId, labels, data);
        }

        function generateTable(tableId, labels, data) {
          const tableContainer = document.getElementById(tableId);
          const table = document.createElement("table");
          const thead = document.createElement("thead");
          const tbody = document.createElement("tbody");

          const headerRow = document.createElement("tr");
          const dateHeader = document.createElement("th");
          dateHeader.textContent = "Date";
          const valueHeader = document.createElement("th");
          valueHeader.textContent = "Value";

          headerRow.appendChild(dateHeader);
          headerRow.appendChild(valueHeader);
          thead.appendChild(headerRow);

          labels.forEach((label, index) => {
            const row = document.createElement("tr");
            const dateCell = document.createElement("td");
            dateCell.textContent = label;
            const valueCell = document.createElement("td");
            valueCell.textContent = data[index];

            row.appendChild(dateCell);
            row.appendChild(valueCell);
            tbody.appendChild(row);
          });

          table.appendChild(thead);
          table.appendChild(tbody);
          tableContainer.innerHTML = "";
          tableContainer.appendChild(table);
        }

        const themeToggle = document.getElementById("theme-toggle");
        const notifIcon = document.querySelector(".notif");
        const notifContent = document.querySelector(".notif-content");
        const notificationList = document.getElementById("notification-list");

        notifIcon.addEventListener("click", function () {
          notifContent.style.display =
            notifContent.style.display === "none" ? "block" : "none";
        });

        document.addEventListener("click", function (event) {
          if (!notifIcon.contains(event.target)) {
            notifContent.style.display = "none";
          }
        });

        document
          .getElementById("dashboard-link")
          .addEventListener("click", function () {
            showSection("dashboard-content");
          });

        document
          .getElementById("analytics-link")
          .addEventListener("click", function () {
            showSection("analytics-content");
          });

        document
          .getElementById("request-device-link")
          .addEventListener("click", function () {
            showSection("device-content");
          });
        document
          .getElementById("add-device-link")
          .addEventListener("click", function () {
            showSection("add-device");
          });
        document
          .getElementById("get-device-link")
          .addEventListener("click", function () {
            showSection("view-device-content");
          });
        function showSection(sectionId) {
          const sections = document.querySelectorAll(".content-section");
          sections.forEach((section) => {
            section.style.display = section.id === sectionId ? "block" : "none";
          });
        }

        showSection("dashboard-content");
      });
      document.addEventListener("DOMContentLoaded", function () {
        document
          .getElementById("loadProfile")
          .addEventListener("click", function (event) {
            event.preventDefault();
            window.location.href = "/profile-content";
          });
      });
      document
        .getElementById("logout-link")
        .addEventListener("click", function (e) {
          e.preventDefault();
          window.location.href = "/logout";
        });

      document.addEventListener("DOMContentLoaded", function () {
        document
          .getElementById("device-form")
          .addEventListener("submit", function (event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const csrfToken = formData.get("csrf_token"); // Extract the CSRF token

            // Convert form data to a plain object
            const data = Object.fromEntries(formData.entries());

            // Configure the Axios request with the CSRF token
            axios
              .post("/dashboard/add_device", data, {
                headers: {
                  "X-CSRFToken": csrfToken, // Include the CSRF token in headers
                },
              })
              .then((response) => {
                alert("Device added successfully!");
              })
              .catch((error) => {
                console.error("There was an error adding the device:", error);
                alert("Error adding device. Please try again.");
              });
          });
      });
      function fetchDevices() {
        axios
          .get("/dashboard/view_devices")
          .then((response) => {
            const devices = response.data;
            const deviceList = document.getElementById("device-list1");
            deviceList.innerHTML = "";

            if (devices.error) {
              deviceList.innerHTML = `<p>${devices.error}</p>`;
            } else {
              devices.forEach((device) => {
                const deviceItem = document.createElement("div");
                deviceItem.className = "device";
                deviceItem.innerHTML = `
                                <p>Entity Name: ${device.entityName}</p>
                                <p>Device IMEI: ${device.deviceIMEI}</p>
                                <p>SIM ICC ID: ${device.simICCId}</p>
                                <p>Battery SL No: ${device.batterySLNo}</p>
                                <p>Panel SL No: ${device.panelSLNo}</p>
                                <p>Luminary SL No: ${device.luminarySLNo}</p>
                                <p>Mobile No: ${device.mobileNo}</p>
                                <p>District: ${device.district}</p>
                                <p>Panchayat: ${device.panchayat}</p>
                                <p>Block: ${device.block}</p>
                                <p>Ward No: ${device.wardNo}</p>
                                <p>Pole No: ${device.poleNo}</p>
                                <p>Active: ${device.active}</p>
                                <p>Installation Date: ${device.installationDate}</p>
                            `;
                deviceList.appendChild(deviceItem);
              });
            }
          })
          .catch((error) => {
            console.error("Error fetching devices:", error);
            const deviceList = document.getElementById("device-list");
            deviceList.innerHTML =
              "<p>Error fetching devices. Please try again later.</p>";
            if (error.response) {
              console.error("Response data:", error.response.data);
              console.error("Response status:", error.response.status);
              console.error("Response headers:", error.response.headers);
            } else if (error.request) {
              console.error("Request data:", error.request);
            } else {
              console.error("Error message:", error.message);
            }
            console.error("Config:", error.config);
          });
      }

      // Fetch devices when the page loads
      window.onload = fetchDevices;

      //request device access
    </script>
  </body>
</html>
