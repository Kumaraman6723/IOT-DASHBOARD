<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../static/css/dashboard.css" />

    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <title>Temp Dashboard</title>
    <style>
      body.dark-theme .chart-container {
        background-color: #34495e;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }
      .chart-container {
        width: 100%;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s, box-shadow 0.3s;
      }
      h1 {
        text-align: center;
        margin-bottom: 20px;
      }
      .content-section {
        padding: 20px; /* Adjust the padding as needed */
      }

      .chart-container {
        margin-bottom: 30px; /* Adjust the margin as needed */
      }

      canvas {
        display: block;
        width: 100%;
        height: 400px; /* Adjust the height as needed */
      }
      /* Add your custom CSS here */

      /* Add your custom CSS here */
      body.dark {
        background-color: #121212;
        color: #e0e0e0;
      }

      body.dark .sidebar,
      body.dark .content nav,
      body.dark .content main {
        background-color: #333;
        color: #e0e0e0;
      }

      body.dark .sidebar .side-menu li a {
        color: #e0e0e0;
      }

      body.dark .sidebar .side-menu li.active a {
        background-color: #444;
      }

      body.dark .sidebar .side-menu li a:hover {
        background-color: #444;
      }

      body.dark .content-section h2 {
        color: #e0e0e0;
      }

      .device-counter {
        display: flex;
        align-items: center;
        margin-top: 20px;
      }

      .device-counter button {
        width: 30px;
        height: 30px;
        font-size: 20px;
        text-align: center;
        line-height: 30px;
        border: 1px solid #ddd;
        background-color: #f2f2f2;
        cursor: pointer;
      }

      .device-counter span {
        width: 30px;
        text-align: center;
        margin: 0 10px;
        font-size: 20px;
      }

      #device-list {
        margin-top: 20px;
      }

      .content-section {
        display: none;
      }

      .table-container {
        margin-top: 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }

      th {
        background-color: #f2f2f2;
      }

      .device-item {
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 10px;
        background-color: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .device-item p {
        margin: 5px 0;
      }

      .status-message {
        color: red;
        font-size: 1em;
        margin-top: 5px;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    
      <div class="sidebar">
        <a href="#" class="logo">
          <i class="bx bx-code-alt"></i>
          <div class="logo-name"><span>TIB</span></div>
        </a>
        <ul class="side-menu">
          <li>
            <a href="#" id="dashboard-link">
              <i class="bx bxs-dashboard"></i>Dashboard
            </a>
          </li>
          <li>
            <a href="#" id="analytics-link">
              <i class="bx bxs-chart"></i>Analytics
            </a>
          </li>
          <li>
            <a href="#" id="request-device-link">
              <i class="bx bx-transfer"></i>Request Device Data
            </a>
          </li>
          <li>
            <a href="#" id="add-device-link">
              <i class="bx bx-plus-circle"></i>Add Device
            </a>
          </li>
          <li>
            <a href="#" id="get-device-link">
              <i class="bx bx-data"></i>Get Device Data
            </a>
          </li>
          <li>
            <a href="#" id="logout-link">
              <i class="bx bx-log-out"></i>Logout
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="content">
      <nav style="background-color: white; /* A vibrant blue color */">
        <div class="nav-left">
          <ul class="breadcrumb"></ul>
        </div>


        
        <i class="bx bx-menu"></i>
        <form action="#"></form>

        <a href="#" id="loadProfile">
          <img
            src="https://img.icons8.com/?size=100&id=rrtYnzKMTlUr&format=png&color=000000"
            alt="Profile"
            class="profile-img"
          />
        </a>
      </nav>

      <main>
        <div id="flash-messages">
          {% with messages = get_flashed_messages() %} {% if messages %}
          <ul class="flashes">
            {% for message in messages %}
            <li>{{ message }}</li>
            {% endfor %}
          </ul>
          {% endif %} {% endwith %}
        </div>
        <div class="container">
          <div id="dashboard-content" class="content-section">
            <h1>Welcome to Your Dashboard</h1>
            <div class="dashboard-wrapper">
              <div class="dashboard-left">
                <div id="activity-overview" class="box">
                  <h2>Activity Overview</h2>
                  <p>
                    Here's a snapshot of your recent activities and device
                    performance.
                  </p>
                  <ul>
                    <li>
                      <span class="efficiency high">95%</span> Device XYZ1
                    </li>
                    <li>
                      <span class="efficiency medium">80%</span> Device XYZ2
                    </li>
                    <li><span class="efficiency low">70%</span> Device XYZ3</li>
                  </ul>
                </div>
                <div id="device-list" class="box">
                  <h2>Registered Devices</h2>
                  <ul id="device-list-items">
                    <li>
                      <span class="status active"></span>
                      <strong>Device IMEI:</strong> 123456789012345
                      <br /><strong>Location:</strong> District 1, Panchayat A
                      <br /><strong>Installation Date:</strong> 2024-01-15
                    </li>
                    <li>
                      <span class="status inactive"></span>
                      <strong>Device IMEI:</strong> 234567890123456
                      <br /><strong>Location:</strong> District 2, Panchayat B
                      <br /><strong>Installation Date:</strong> 2023-12-01
                    </li>
                    <li>
                      <span class="status active"></span>
                      <strong>Device IMEI:</strong> 345678901234567
                      <br /><strong>Location:</strong> District 3, Panchayat C
                      <br /><strong>Installation Date:</strong> 2024-03-20
                    </li>
                  </ul>
                </div>
              </div>
              <div class="dashboard-right">
                <div id="energy-production" class="box">
                  <h2>Energy Production</h2>
                  <div class="chart-placeholder">
                    <div class="bar" style="height: 60%"></div>
                    <div class="bar" style="height: 80%"></div>
                    <div class="bar" style="height: 40%"></div>
                    <div class="bar" style="height: 90%"></div>
                    <div class="bar" style="height: 70%"></div>
                  </div>
                </div>
                <div id="weather-forecast" class="box">
                  <h2>Weather Forecast</h2>
                  <div class="weather-icons">
                    <div class="weather-day">
                      <i class="fas fa-sun"></i>
                      <span>Mon</span>
                    </div>
                    <div class="weather-day">
                      <i class="fas fa-cloud-sun"></i>
                      <span>Tue</span>
                    </div>
                    <div class="weather-day">
                      <i class="fas fa-cloud"></i>
                      <span>Wed</span>
                    </div>
                    <div class="weather-day">
                      <i class="fas fa-sun"></i>
                      <span>Thu</span>
                    </div>
                    <div class="weather-day">
                      <i class="fas fa-cloud-sun"></i>
                      <span>Fri</span>
                    </div>
                  </div>
                </div>
                <div id="device-info" class="box">
                  <h2>About IoT Solar Devices</h2>
                  <p><strong>What is an IoT Solar Device?</strong></p>
                  <p>
                    IoT solar devices are advanced systems that integrate solar
                    energy technology with Internet of Things (IoT)
                    capabilities. These devices monitor, control, and manage
                    solar energy generation and usage in real time.
                  </p>
                  <p><strong>How Does It Work?</strong></p>
                  <ul>
                    <li>
                      <strong>Data Collection:</strong> Solar panels equipped
                      with sensors collect data on sunlight intensity, panel
                      temperature, and energy output.
                    </li>
                    <li>
                      <strong>Data Transmission:</strong> The collected data is
                      transmitted to a central server via wireless
                      communication.
                    </li>
                    <li>
                      <strong>Analysis & Monitoring:</strong> The server
                      analyzes the data to provide insights on energy
                      production, efficiency, and potential issues.
                    </li>
                    <li>
                      <strong>Control:</strong> Users can remotely monitor and
                      control the devices through a web or mobile application,
                      ensuring optimal performance.
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="analytics-content" class="content-section">
          <h2>Analytics Content</h2>
          <div class="chart-container">
            <h1>Real-time Temperature and Humidity Monitor</h1>
            <canvas id="realTimeChart2"></canvas>
          </div>

          <div class="chart-container">
            <h1>Real-time Voltage and Current Monitor</h1>
            <canvas id="realTimeChart1"></canvas>
          </div>
        </div>
        <div id="device-content" class="content-section">
          <h2>Request Device Data</h2>
          <form
            id="device-form1"
            method="POST"
            action="/dashboard/request_device"
          >
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="device-counter">
              <button
                id="decrease-device"
                type="button"
                onclick="changeDeviceCount(-1)"
              >
                -
              </button>
              <span id="device-count">0</span>
              <button
                id="increase-device"
                type="button"
                onclick="changeDeviceCount(1)"
              >
                +
              </button>
            </div>
            <input
              type="hidden"
              id="device_count"
              name="device_count"
              value="0"
            />
            <div
              id="loading-overlay"
              class="loading-overlay"
              style="display: none"
            >
              <div class="spinner"></div>
            </div>

            <button id="request-device" type="submit">Request</button>
          </form>

          <div id="pending-request" style="display: none">
            <p>Pending Request: Please wait for admin to approve.</p>
          </div>
        </div>

        <div id="add-device" class="content-section hidden">
          <h2>Add Devices</h2>
          <div id="request-device-message" class="status-message hidden">
            You need to request devices to access this section.
          </div>
          <form
            id="device-form"
            method="POST"
            action="/dashboard/add_device"
            class="hidden"
          >
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <label for="entityName">Entity Name</label>
            <input type="text" id="entityName" name="entityName" required />
            <label for="deviceIMEI">Device IMEI</label>
            <input type="text" id="deviceIMEI" name="deviceIMEI" required />
            <label for="simICCId">SIM ICC ID</label>
            <input type="text" id="simICCId" name="simICCId" required />
            <label for="batterySLNo">Battery SL No</label>
            <input type="text" id="batterySLNo" name="batterySLNo" required />
            <label for="panelSLNo">Panel SL No</label>
            <input type="text" id="panelSLNo" name="panelSLNo" required />
            <label for="luminarySLNo">Luminary SL No</label>
            <input type="text" id="luminarySLNo" name="luminarySLNo" required />
            <label for="mobileNo">Mobile No</label>
            <input type="text" id="mobileNo" name="mobileNo" required />
            <label for="district">District</label>
            <input type="text" id="district" name="district" required />
            <label for="panchayat">Panchayat</label>
            <input type="text" id="panchayat" name="panchayat" required />
            <label for="block">Block</label>
            <input type="text" id="block" name="block" required />
            <label for="wardNo">Ward No</label>
            <input type="text" id="wardNo" name="wardNo" required />
            <label for="poleNo">Pole No</label>
            <input type="text" id="poleNo" name="poleNo" required />
            <label for="active">Active</label>
            <select id="active" name="active" required>
              <option value="true">True</option>
              <option value="false">False</option>
            </select>
            <label for="installationDate">Installation Date</label>
            <input
              type="date"
              id="installationDate"
              name="installationDate"
              required
            />
            <button type="submit">Submit</button>
            <div id="loading-overlay-add" class="loading-overlay">
              <div class="spinner"></div>
            </div>
          </form>
        </div>
        <div id="view-device-content" class="content-section hidden">
          <h2>View Devices Content</h2>
          <div id="add-device-message" class="status-message hidden">
            You need to add a device to access this section.
          </div>
          <div id="device-list1">
            <!-- Device data will be injected here -->
          </div>
        </div>
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@2.0.2/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.1.0/dist/chartjs-adapter-luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2.0.0"></script>
    <script>
      let currentPage = 1;
      const pageSize = 3;

      function fetchDevices(page = 1) {
        axios
          .get(`/dashboard/view_devices?page=${page}&page_size=${pageSize}`)
          .then((response) => {
            const devicesData = response.data;
            const devices = devicesData.devices;
            const totalDevices = devicesData.total_devices;
            const deviceList = document.getElementById("device-list1");
            deviceList.innerHTML = "";

            if (devices.error) {
              deviceList.innerHTML = `<p>${devices.error}</p>`;
            } else {
              devices.forEach((device) => {
                const deviceItem = document.createElement("div");
                deviceItem.className = "device";
                deviceItem.innerHTML = `
                    <p>Entity Name: ${device.entityName}</p>
                    <p>Device IMEI: ${device.deviceIMEI}</p>
                    <p>SIM ICC ID: ${device.simICCId}</p>
                    <p>Battery SL No: ${device.batterySLNo}</p>
                    <p>Panel SL No: ${device.panelSLNo}</p>
                    <p>Luminary SL No: ${device.luminarySLNo}</p>
                    <p>Mobile No: ${device.mobileNo}</p>
                    <p>District: ${device.district}</p>
                    <p>Panchayat: ${device.panchayat}</p>
                    <p>Block: ${device.block}</p>
                    <p>Ward No: ${device.wardNo}</p>
                    <p>Pole No: ${device.poleNo}</p>
                    <p>Active: ${device.active}</p>
                    <p>Installation Date: ${device.installationDate}</p>
                  `;
                deviceList.appendChild(deviceItem);
              });

              // Create pagination controls
              const paginationControls = document.createElement("div");
              paginationControls.className = "pagination-controls";

              const prevButton = document.createElement("button");
              prevButton.innerText = "Previous";
              prevButton.disabled = page === 1;
              prevButton.onclick = () => {
                fetchDevices(page - 1);
              };
              paginationControls.appendChild(prevButton);

              const nextButton = document.createElement("button");
              nextButton.innerText = "Next";
              nextButton.disabled = page * pageSize >= totalDevices;
              nextButton.onclick = () => {
                fetchDevices(page + 1);
              };
              paginationControls.appendChild(nextButton);

              deviceList.appendChild(paginationControls);
            }
          })
          .catch((error) => {
            console.error("Error fetching devices:", error);
            const deviceList = document.getElementById("device-list1");
            deviceList.innerHTML =
              "<p>Error fetching devices. Please try again later.</p>";
            if (error.response) {
              console.error("Response data:", error.response.data);
              console.error("Response status:", error.response.status);
              console.error("Response headers:", error.response.headers);
            } else if (error.request) {
              console.error("Request data:", error.request);
            } else {
              console.error("Error message:", error.message);
            }
            console.error("Config:", error.config);
          });
      }

      document.addEventListener("DOMContentLoaded", () => {
        fetchDevices(currentPage);
      });
    </script>
    <script>
      let isDarkTheme = false;

      function createChart1() {
        const ctx1 = document.getElementById("realTimeChart1").getContext("2d");
        let chart1;

        if (chart1) {
          chart1.destroy();
        }

        chart1 = new Chart(ctx1, {
          type: "line",
          data: {
            datasets: [
              {
                label: "Voltage (V)",
                data: [],
                borderColor: "rgb(255, 159, 64)",
                backgroundColor: "rgba(255, 159, 64, 0.2)",
                fill: true,
                tension: 0.4,
              },
              {
                label: "Current (A)",
                data: [],
                borderColor: "rgb(75, 192, 192)",
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: {
                type: "realtime",
                realtime: {
                  duration: 20000,
                  refresh: 1000,
                  delay: 2000,
                  onRefresh: (chart) => {
                    chart.data.datasets.forEach((dataset) => {
                      dataset.data.push({
                        x: Date.now(),
                        y: dataset.label.includes("Voltage")
                          ? (Math.random() * 10 + 5).toFixed(1)
                          : (Math.random() * 5 + 1).toFixed(1),
                      });
                    });
                  },
                },
                time: {
                  unit: "second",
                },
                grid: {
                  color: "rgba(0, 0, 0, 0.1)",
                },
                ticks: {
                  color: "#2c3e50",
                },
              },
              y: {
                beginAtZero: false,
                suggestedMin: 0,
                suggestedMax: 15,
                grid: {
                  color: "rgba(0, 0, 0, 0.1)",
                },
                ticks: {
                  color: "#2c3e50",
                },
              },
            },
            plugins: {
              legend: {
                position: "top",
                labels: {
                  color: "#2c3e50",
                },
              },
            },
            animation: {
              duration: 1000,
              easing: "linear",
            },
          },
        });
      }

      function createChart2() {
        const ctx2 = document.getElementById("realTimeChart2").getContext("2d");
        let chart2;

        if (chart2) {
          chart2.destroy();
        }

        chart2 = new Chart(ctx2, {
          type: "line",
          data: {
            datasets: [
              {
                label: "Temperature (°C)",
                data: [],
                borderColor: "rgb(255, 99, 132)",
                backgroundColor: "rgba(255, 99, 132, 0.2)",
                fill: true,
                tension: 0.4,
              },
              {
                label: "Humidity (%)",
                data: [],
                borderColor: "rgb(54, 162, 235)",
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: {
                type: "realtime",
                realtime: {
                  duration: 20000,
                  refresh: 1000,
                  delay: 2000,
                  onRefresh: (chart) => {
                    chart.data.datasets.forEach((dataset) => {
                      dataset.data.push({
                        x: Date.now(),
                        y: dataset.label.includes("Temperature")
                          ? (Math.random() * 10 + 20).toFixed(1)
                          : (Math.random() * 20 + 40).toFixed(1),
                      });
                    });
                  },
                },
                time: {
                  unit: "second",
                },
                grid: {
                  color: "rgba(0, 0, 0, 0.1)",
                },
                ticks: {
                  color: "#2c3e50",
                },
              },
              y: {
                beginAtZero: false,
                suggestedMin: 15,
                suggestedMax: 65,
                grid: {
                  color: "rgba(0, 0, 0, 0.1)",
                },
                ticks: {
                  color: "#2c3e50",
                },
              },
            },
            plugins: {
              legend: {
                position: "top",
                labels: {
                  color: "#2c3e50",
                },
              },
            },
            animation: {
              duration: 1000,
              easing: "linear",
            },
          },
        });
      }

      createChart1();
      createChart2();
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const dashboardLink = document.getElementById("dashboard-link");
        const analyticsLink = document.getElementById("analytics-link");
        const dashboardContent = document.getElementById("dashboard-content");
        const analyticsContent = document.getElementById("analytics-content");

        function showSection(section) {
          // Hide all sections
          document.querySelectorAll(".content-section").forEach((sec) => {
            sec.style.display = "none";
          });
          // Show the selected section
          section.style.display = "block";
        }

        dashboardLink.addEventListener("click", function (e) {
          e.preventDefault();
          showSection(dashboardContent);
        });

        analyticsLink.addEventListener("click", function (e) {
          e.preventDefault();
          showSection(analyticsContent);
        });

        // Initial display
        showSection(dashboardContent);

        fetch("/dashboard/get_device_list")
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              console.error("Error fetching device list:", data.error);
              return;
            }

            const deviceListItems =
              document.getElementById("device-list-items");
            deviceListItems.innerHTML = ""; // Clear existing content

            if (data.devices.length === 0) {
              const noDevicesMessage = document.createElement("li");
              noDevicesMessage.textContent =
                "No devices are registered for now.";
              deviceListItems.appendChild(noDevicesMessage);
            } else {
              data.devices.forEach((device) => {
                const listItem = document.createElement("li");
                const link = document.createElement("a");
                link.href = "#";
                link.textContent = `Device ID: ${device.device_id}`;
                link.addEventListener("click", function (e) {
                  e.preventDefault();
                  showSection(analyticsContent);
                });
                listItem.appendChild(link);
                deviceListItems.appendChild(listItem);
              });
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      });
    </script>

    <script>
      function changeDeviceCount(delta) {
        const deviceCountElement = document.getElementById("device-count");
        let deviceCount = parseInt(deviceCountElement.textContent, 10);
        deviceCount += delta;

        if (deviceCount < 0) deviceCount = 0;
        if (deviceCount === 0) {
          displayFlashMessage("Kindly Select at least 1 device");
        }
        deviceCountElement.textContent = deviceCount;
        document.getElementById("device_count").value = deviceCount;
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const sideLinks = document.querySelectorAll(
          ".sidebar .side-menu li a:not(.logout)"
        );
        const menuBar = document.querySelector(".content nav .bx.bx-menu");
        const sideBar = document.querySelector(".sidebar");

        const loadingOverlay = document.getElementById("loading-overlay");

        sideLinks.forEach((item) => {
          const li = item.parentElement;
          item.addEventListener("click", () => {
            sideLinks.forEach((i) => {
              i.parentElement.classList.remove("active");
            });
            li.classList.add("active");
          });
        });

        menuBar.addEventListener("click", () => {
          sideBar.classList.toggle("close");
        });

        window.addEventListener("resize", () => {
          if (window.innerWidth < 768) {
            sideBar.classList.add("close");
          } else {
            sideBar.classList.remove("close");
          }
        });

        loadLastActiveSection();

        document
          .getElementById("dashboard-link")
          .addEventListener("click", function () {
            showSection("dashboard-content");
          });

        document
          .getElementById("analytics-link")
          .addEventListener("click", function () {
            showSection("analytics-content");
          });

        document
          .getElementById("request-device-link")
          .addEventListener("click", function () {
            showSection("device-content");
          });

        document
          .getElementById("add-device-link")
          .addEventListener("click", function () {
            showSection("add-device");
          });

        document
          .getElementById("get-device-link")
          .addEventListener("click", function () {
            showSection("view-device-content");
            fetchDevices();
          });

        document
          .getElementById("loadProfile")
          .addEventListener("click", function (event) {
            event.preventDefault();
            window.location.href = "/profile-content";
          });

        document
          .getElementById("logout-link")
          .addEventListener("click", function (e) {
            e.preventDefault();
            window.location.href = "/logout";
          });

        document
          .getElementById("device-form")
          .addEventListener("submit", function (event) {
            event.preventDefault();

            const loadingOverlayAdd = document.getElementById(
              "loading-overlay-add"
            );
            loadingOverlayAdd.style.display = "flex";

            const formData = new FormData(event.target);
            const csrfToken = formData.get("csrf_token");
            const data = Object.fromEntries(formData.entries());

            axios
              .get("/dashboard/check_device_requests")
              .then((response) => {
                const { requested_devices, added_devices } = response.data;

                if (added_devices >= requested_devices) {
                  loadingOverlayAdd.style.display = "none";
                  displayFlashMessage(
                    "You need to request more devices to add a device."
                  );
                  setTimeout(() => {
                    location.reload();
                  }, 2000);
                } else {
                  axios
                    .post("/dashboard/add_device", data, {
                      headers: {
                        "X-CSRFToken": csrfToken,
                      },
                    })
                    .then((response) => {
                      loadingOverlayAdd.style.display = "none";
                      displayFlashMessage("Device Added Successfully");
                      setTimeout(() => {
                        location.reload();
                      }, 4000); // Adjust the delay as needed (2000ms = 2 seconds)
                    })
                    .catch((error) => {
                      loadingOverlayAdd.style.display = "none";
                      console.error(
                        "There was an error adding the device:",
                        error
                      );
                      displayFlashMessage(
                        "Error adding device. Please try again."
                      );
                    });
                }
              })
              .catch((error) => {
                loadingOverlayAdd.style.display = "none";
                console.error(
                  "There was an error checking device requests:",
                  error
                );
                displayFlashMessage(
                  "Error checking device requests. Please try again."
                );
              });
          });

        loadLastActiveSection();

        document
          .getElementById("get-device-link")
          .addEventListener("click", function () {
            showSection("view-device-content");
            // Call fetchDevices function when the link is clicked
          });

        function showSection(sectionId) {
          // Hide all sections
          document.querySelectorAll(".content-section").forEach((section) => {
            section.style.display = "none";
          });
          // Show the selected section
          document.getElementById(sectionId).style.display = "block";
        }

        // Load last active section

        // Fetch devices
        fetchDevices();

        function showSection(sectionId) {
          const sections = document.querySelectorAll(".content-section");
          sections.forEach((section) => {
            section.style.display = section.id === sectionId ? "block" : "none";
          });
          saveCurrentSection(sectionId);
          updateSidebarActiveState(sectionId);
        }

        // Fetch devices when the page loads

        //request device access

        window.onload = function () {
          /* let registeredDevicesCount = 0;

          // Fetch the registered device count
          axios
            .get("/dashboard/get_device_count")
            .then((response) => {
              if (response.data.registered_devices_count !== undefined) {
                registeredDevicesCount = response.data.registered_devices_count;
              } else {
                console.error("Error fetching registered device count.");
              }
            })
            .catch((error) => {
              console.error("Error fetching registered device count.", error);
            });*/

          // Check the device request status
          axios
            .get("/dashboard/get_request_status")
            .then((response) => {
              if (response.data.status === "pending") {
                document.getElementById("device-form1").style.display = "none";
                document.getElementById("pending-request").style.display =
                  "block";
              } else {
                document.getElementById("device-form1").style.display = "block";
                document.getElementById("pending-request").style.display =
                  "none";
              }
            })
            .catch((error) => {
              console.error("Error fetching device request status.", error);
            });

          document
            .getElementById("device-form1")
            .addEventListener("submit", function (event) {
              event.preventDefault();

              const formData = new FormData(event.target);
              const csrfToken = formData.get("csrf_token");
              const deviceCount = parseInt(formData.get("device_count"), 10);

              if (deviceCount === 0) {
                displayFlashMessage("Kindly Select at least 1 device");
                return;
              }

              const data = Object.fromEntries(formData.entries());
              document.getElementById("loading-overlay").style.display = "flex";

              axios
                .post("/dashboard/request_device", data, {
                  headers: {
                    "X-CSRFToken": csrfToken,
                  },
                })
                .then((response) => {
                  document.getElementById("loading-overlay").style.display =
                    "none";
                  if (response.data.redirect) {
                    window.location.href = response.data.redirect;
                  } else {
                    // Hide the form and show pending request message
                    document.getElementById("device-form1").style.display =
                      "none";
                    document.getElementById("pending-request").style.display =
                      "block";
                    setTimeout(() => {
                      location.reload();
                    }, 2000); // Adjust the delay as needed (2000ms = 2 seconds)
                  }
                })
                .catch((error) => {
                  document.getElementById("loading-overlay").style.display =
                    "none";
                  if (error.response && error.response.data) {
                    displayFlashMessage(
                      error.response.data.message,
                      error.response.data.category
                    );
                  } else {
                    displayFlashMessage(
                      "Error submitting device request. Please try again.",
                      "error"
                    );
                  }
                });
            });
        };

        function displayFlashMessage(message, category) {
          const flashMessagesElement =
            document.getElementById("flash-messages");
          const ulElement = document.createElement("ul");
          ulElement.className = "flashes";
          const liElement = document.createElement("li");
          liElement.className = category;
          liElement.textContent = message;
          ulElement.appendChild(liElement);

          flashMessagesElement.innerHTML = ""; // Clear previous messages
          flashMessagesElement.appendChild(ulElement);

          // Remove the flash message after 2 seconds and reload the content section
          setTimeout(() => {
            flashMessagesElement.innerHTML = "";
            // Clear the flash message
            // Reload the content section
          }, 2000);
        }

        function saveCurrentSection(sectionId) {
          sessionStorage.setItem("currentDashboardSection", sectionId);
        }

        function loadLastActiveSection() {
          const lastSection = sessionStorage.getItem("currentDashboardSection");
          if (lastSection) {
            showSection(lastSection);
          } else {
            showSection("dashboard-content");
          }
        }

        function updateSidebarActiveState(sectionId) {
          const sideLinks = document.querySelectorAll(
            ".sidebar .side-menu li a:not(.logout)"
          );
          sideLinks.forEach((item) => {
            const li = item.parentElement;
            if (item.id === `${sectionId.replace("-content", "")}-link`) {
              li.classList.add("active");
            } else {
              li.classList.remove("active");
            }
          });
        }
      });
      document.addEventListener("DOMContentLoaded", function () {
        // Function to show or hide messages and forms based on approval status
        function updateMenuVisibility() {
          axios
            .get("/dashboard/get_request_status")
            .then((response) => {
              const requestDeviceMessage = document.getElementById(
                "request-device-message"
              );
              const deviceForm = document.getElementById("device-form");

              if (response.data.status === "approved") {
                requestDeviceMessage.classList.add("hidden");
                deviceForm.classList.remove("hidden");
              } else {
                requestDeviceMessage.classList.remove("hidden");
                deviceForm.classList.add("hidden");
              }

              axios
                .get("/dashboard/check_device_added")
                .then((response) => {
                  const addDeviceMessage =
                    document.getElementById("add-device-message");

                  if (response.data.device_added) {
                    addDeviceMessage.classList.add("hidden");
                  } else {
                    addDeviceMessage.classList.remove("hidden");
                  }
                })
                .catch((error) => {
                  console.error("Error checking if device is added:", error);
                });
            })
            .catch((error) => {
              console.error("Error getting request status:", error);
            });
        }

        // Check the user's status on page load
        updateMenuVisibility();

        // Event listener for the "Add Device" link
        document
          .getElementById("add-device-link")
          .addEventListener("click", function (event) {
            const requestDeviceMessage = document.getElementById(
              "request-device-message"
            );
            if (requestDeviceMessage.classList.contains("hidden")) {
              showSection("add-device");
            } else {
              alert("You need to request devices to access this section.");
            }
            event.preventDefault();
          });

        // Event listener for the "Get Device Data" link
        document
          .getElementById("get-device-link")
          .addEventListener("click", function (event) {
            const addDeviceMessage =
              document.getElementById("add-device-message");
            if (addDeviceMessage.classList.contains("hidden")) {
              showSection("view-device-content");
            } else {
              alert("You need to add a device to access this section.");
            }
            event.preventDefault();
          });

        // Existing event listeners and other JavaScript logic...
      });

      function showSection(sectionId) {
        // Hide all content sections
        const sections = document.querySelectorAll(".content-section");
        sections.forEach((section) => {
          section.classList.add("hidden");
        });

        // Show the selected section
        const section = document.getElementById(sectionId);
        section.classList.remove("hidden");
      }
    </script>
    <div id="loading-overlay" style="display: none">
      <div class="spinner"></div>
    </div>
    <footer class="footer-custom">
      <div class="footer-content">
        <p class="footer-year">© 2024 Company, Inc</p>
        <a href="/" class="footer-logo">
          <img src="static/assets/nuke.svg" alt="Logo" width="40" height="32" />
        </a>
        <ul class="footer-nav">
          <li class="nav-item"><a href="#" class="nav-link">Home</a></li>
          <li class="nav-item"><a href="#" class="nav-link">Features</a></li>
          <li class="nav-item"><a href="#" class="nav-link">Pricing</a></li>
          <li class="nav-item"><a href="#" class="nav-link">FAQs</a></li>
          <li class="nav-item"><a href="#" class="nav-link">About</a></li>
        </ul>
      </div>
    </footer>
  </body>
</html>
